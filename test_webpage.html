<html>

<body>

	<br><br><br>

	<center>
	<h1>
		Time left: <b id="time">600</b>

		<br><br>

		What is <b id="num1">a</b> <b id="op"></b> <b id="num2"></b>?
	</h1>

	<br><br>

	<input type="number" id="ans" />

	<br><br>

	<h1>
		Number correct: <b id="score">0</b>

		<br><br>

	</h1>

	</center>

	<div id="counter">0</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="setImmediate.js"></script>
	<script>

		var INTERVENTION = 2; // 0 = nothing, 1 = just green, 2 = flashes 
		// order: 

		if (INTERVENTION === 1) document.body.style.backgroundColor = "#00FF00";

		function getRandomInt(max) {
			return Math.floor(Math.random() * Math.floor(max));
		}

		function getAns(num1, num2, op) {
			if (op === "x") {
				return num1 * num2;
			}
			if (op === "/") {
				return num1 / num2;
			}
			if (op === "+") {
				return num1 + num2;
			}
			if (op === "-") {
				return num1 - num2;
			}
		}

		function getFactors(num) {
		  const isEven = num % 2 === 0;
		  let inc = isEven ? 1 : 2;
		  let factors = [1, num];

		  for (let curFactor = isEven ? 2 : 3; Math.pow(curFactor, 2) <= num; curFactor += inc) {
		    if (num % curFactor !== 0) continue;
		    factors.push(curFactor);
		    let compliment = num / curFactor;
		    if (compliment !== curFactor) factors.push(compliment);
		  }

		  return factors;
		}

		var possibleOps = ["x", "/", "+", "-"];

		var score = 0;
		var timeLeft = 600;

		var op = possibleOps[Math.floor(Math.random()*possibleOps.length)];
		var range = 100000;
		if (op === "+" || op === "-") range = 10000;
		if (op === "x") range = 500;
		var num1 = getRandomInt(range);
		var num2 = getRandomInt(range);
		if (op === "/") {
			var divisors = getFactors(num1);
			num2 = divisors[Math.floor(Math.random()*divisors.length)];
			if (num2 === undefined) num2 = num1;
		}
		var ans = getAns(num1, num2, op);

		$(document).ready(function() {
			op = possibleOps[Math.floor(Math.random()*possibleOps.length)];
			range = 1000000;
			if (op === "+" || op === "-") range = 10000;
			if (op === "x") range = 500;
			num1 = getRandomInt(range);
			num2 = getRandomInt(range);
			if (op === "/") {
				var divisors = getFactors(num1);
				console.log(divisors);
				num2 = divisors[Math.floor(Math.random()*divisors.length)];
				if (num2 === undefined) num2 = num1;
			}
			ans = getAns(num1, num2, op);

			$("#num1").text(num1 + "");
			$("#op").text(op);
			$("#num2").text(num2 + "");

			$("#ans").on("change paste keyup", function() {
    			var num = parseInt($("#ans").val());

				if (num === ans) {
					score++;

					op = possibleOps[Math.floor(Math.random()*possibleOps.length)];
					range = 1000000;
					if (op === "+" || op === "-") range = 10000;
					if (op === "x") range = 500;
					num1 = getRandomInt(range);
					num2 = getRandomInt(range);
					if (op === "/") {
						var divisors = getFactors(num1);
						num2 = divisors[Math.floor(Math.random()*divisors.length)];
						if (num2 === undefined) num2 = num1;
					}
					ans = getAns(num1, num2, op);

					$("#num1").text(num1 + "");
					$("#op").text(op);
					$("#num2").text(num2 + "");

					$("#score").text(score + "");

					$("#ans").val("");
				}
			});

			var count = 0;
		
			var update1 = function() {
				count++;
				$("#counter").html(count);

				if (INTERVENTION === 2) {
					if (count % 3000 === 0) {
						document.body.style.backgroundColor = "#00FF00";
						setImmediate(update2);
					}
				}

				if (INTERVENTION === 3) {
					if (count % 900 === 0) {
						document.body.style.backgroundColor = "#00FF00";
						setImmediate(update2);
					}
				}
	
				if (count % 4000 === 0 && timeLeft > 0) {
					timeLeft--;
					$("#time").text(timeLeft + "");
				}

				setImmediate(update1);
			};

			var update2 = function() {
				document.body.style.backgroundColor = "#FFFFFF"; 
			}

			setImmediate(update1);

		});
	</script>
</body>


</html>